<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¬¸ë‘¥ë‹·ì»´ - ì¼ê¸°ì¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background: #f3f4f6; padding-top: 4rem; }
    .back-link {
      position: absolute; top: 1rem; left: 1rem;
      background: rgba(255,255,255,0.7); padding: 0.5rem 1rem;
      border-radius: 0.375rem; font-weight: 500; color: #1f2937; text-decoration: none;
    }
    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
<a href="index.html" class="back-link">â† í™ˆìœ¼ë¡œ</a>

<div class="max-w-3xl mx-auto px-6 py-12 space-y-12">
  <section>
    <h1 class="text-3xl font-bold text-indigo-600 mb-6">ì¼ê¸° ì‘ì„±</h1>
    <form id="diary-form" class="space-y-6 bg-white p-6 rounded-lg shadow">
      <div>
        <label class="block text-sm font-medium mb-1">ë‚ ì§œ</label>
        <input type="date" id="date" class="w-full px-4 py-2 border rounded-md" required />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">ê¸°ë¶„</label>
        <select id="mood" class="w-full px-4 py-2 border rounded-md">
          <option>ğŸ˜Š í–‰ë³µ</option><option>ğŸ˜ ë³´í†µ</option><option>ğŸ˜¢ ìŠ¬í””</option><option>ğŸ˜  í™”ë‚¨</option><option>ğŸ˜´ í”¼ê³¤</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">ì‚¬ì§„ ì²¨ë¶€</label>
        <input type="file" id="photo" accept="image/*" class="w-full" />
        <div id="preview" class="mt-2"></div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">ë‚´ìš©</label>
        <textarea id="content" rows="6" class="w-full px-4 py-2 border rounded-md" required></textarea>
      </div>
      <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700">ì €ì¥</button>
    </form>
  </section>

  <section>
    <h2 class="text-2xl font-bold text-indigo-600 mb-4">ì¼ê¸° ëª©ë¡</h2>
    <div id="entriesList" class="space-y-6"></div>
  </section>
</div>

<!-- âœ… Firebase ì—°ë™ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDxzmgN0tAJv27T2h2JWsnpgQDZNoUguns",
    authDomain: "ourstory-shared.firebaseapp.com",
    projectId: "ourstory-shared",
    storageBucket: "ourstory-shared.appspot.com",
    messagingSenderId: "912303672959",
    appId: "1:912303672959:web:d86696d49305c86877794a",
    measurementId: "G-HJL3VM7J73"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const form = document.getElementById('diary-form');
  const preview = document.getElementById('preview');
  const photoInput = document.getElementById('photo');
  const entriesList = document.getElementById('entriesList');

  let photoDataURL = '';

  // âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ë¦¬ì‚¬ì´ì§•
  photoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      photoDataURL = event.target.result;
      preview.innerHTML = `<img src="${photoDataURL}" class="w-40 h-40 object-cover rounded" />`;
    };
    reader.readAsDataURL(file);
  });

  // âœ… í¼ ì œì¶œ ì‹œ Firestoreì— ì €ì¥
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newEntry = {
      date: form.date.value,
      mood: form.mood.value,
      content: form.content.value,
      photo: photoDataURL,
      createdAt: new Date()
    };
    try {
      await addDoc(collection(db, "diary"), newEntry);
      form.reset();
      preview.innerHTML = '';
      photoDataURL = '';
    } catch (err) {
      console.error("ì €ì¥ ì‹¤íŒ¨:", err);
      alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  });

  // âœ… ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  onSnapshot(collection(db, "diary"), (snapshot) => {
    entriesList.innerHTML = '';
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const div = document.createElement('div');
      div.className = 'bg-white rounded-lg shadow p-4';
      div.innerHTML = `
        <div class="flex justify-between mb-2">
          <p class="text-sm text-gray-600">${d.date} / ${d.mood}</p>
          <button class="text-red-500 text-sm" data-id="${docSnap.id}">ì‚­ì œ</button>
        </div>
        ${d.photo ? `<img src="${d.photo}" class="w-full h-48 object-cover mb-2 rounded" />` : ''}
        <p class="whitespace-pre-line">${d.content}</p>
      `;
      div.querySelector('button').addEventListener('click', async () => {
        if (confirm("ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          await deleteDoc(doc(db, "diary", docSnap.id));
        }
      });
      entriesList.appendChild(div);
    });
  });
</script>
</body>
</html>
