<script type="module">
  import { db, storage } from './firebase.js';
  import {
    collection, addDoc, getDocs, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
  import {
    ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-storage.js";

  const diaryCol = collection(db, 'diary');
  const form = document.getElementById('diary-form');
  const list = document.getElementById('entriesList');
  const photoInput = document.getElementById('photo');

  let editingId = null;

  // 업로드된 사진 Firebase Storage에 저장
  async function uploadPhoto(file) {
    const storageRef = ref(storage, 'diary/' + Date.now() + '_' + file.name);
    const snapshot = await uploadBytes(storageRef, file);
    return await getDownloadURL(snapshot.ref);
  }

  // 저장 또는 수정
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const date = form.date.value;
    const mood = form.mood.value;
    const content = form.content.value;
    let photoUrl = '';

    if (photoInput.files[0]) {
      photoUrl = await uploadPhoto(photoInput.files[0]);
    }

    if (editingId) {
      await updateDoc(doc(db, 'diary', editingId), { date, mood, content, photo: photoUrl });
      editingId = null;
    } else {
      await addDoc(diaryCol, { date, mood, content, photo: photoUrl });
    }

    form.reset();
    loadEntries();
  });

  async function loadEntries() {
    list.innerHTML = '';
    const snapshot = await getDocs(diaryCol);
    snapshot.forEach(docSnap => {
      const entry = docSnap.data();
      const div = document.createElement('div');
      div.className = 'p-4 bg-white rounded shadow mb-4';
      div.innerHTML = `
        <p><strong>날짜:</strong> ${entry.date}</p>
        <p><strong>기분:</strong> ${entry.mood}</p>
        ${entry.photo ? `<img src="${entry.photo}" class="w-32 h-32 object-cover mt-2" />` : ''}
        <p class="mt-2">${entry.content}</p>
        <button class="edit text-yellow-600" data-id="${docSnap.id}">수정</button>
        <button class="delete text-red-600 ml-4" data-id="${docSnap.id}">삭제</button>
      `;
      list.appendChild(div);
    });

    // 이벤트 위임
    list.querySelectorAll('.edit').forEach(btn =>
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const entryDoc = await getDocs(diaryCol);
        entryDoc.forEach(docSnap => {
          if (docSnap.id === id) {
            const entry = docSnap.data();
            form.date.value = entry.date;
            form.mood.value = entry.mood;
            form.content.value = entry.content;
            editingId = id;
          }
        });
      })
    );

    list.querySelectorAll('.delete').forEach(btn =>
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        await deleteDoc(doc(db, 'diary', id));
        loadEntries();
      })
    );
  }

  window.addEventListener('DOMContentLoaded', loadEntries);
</script>
